<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏õ‡∏•‡∏≤‡∏Å‡∏±‡∏î (Offline)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; }
        .container { max-width: 900px; }
        .timer { font-size: 2.5rem; font-weight: bold; color: #dc3545; }
        .finished-timer { color: #198754; animation: blink 1.5s linear infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }
        #custom-time-container { display: none; }
    </style>
</head>
<body>
    <audio id="notification-sound" src="https://www.soundjay.com/buttons/sounds/button-16.mp3" preload="auto"></audio>

    <div class="container my-4">
        <h1 class="text-center mb-4">üìù ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏õ‡∏•‡∏≤‡∏Å‡∏±‡∏î</h1>

        <div class="card mb-4">
            <div class="card-header bg-primary text-white">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏π‡πà‡πÉ‡∏´‡∏°‡πà</div>
            <div class="card-body">
                <form id="match-form">
                    <div class="row">
                        <div class="col-md-6">
                            <h5 class="text-danger">‡∏ù‡πà‡∏≤‡∏¢‡πÅ‡∏î‡∏á</h5>
                            <div class="mb-2"><label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á</label><input type="text" class="form-control" id="red-owner-name" required></div>
                            <div class="mb-2"><label class="form-label">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏õ‡∏•‡∏≤ (‡∏Å‡∏£‡∏±‡∏°)</label><input type="number" step="0.001" class="form-control" id="red-fish-weight" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1.855" required></div>
                        </div>
                        <div class="col-md-6">
                            <h5 class="text-primary">‡∏ù‡πà‡∏≤‡∏¢‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô</h5>
                            <div class="mb-2"><label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á</label><input type="text" class="form-control" id="blue-owner-name" required></div>
                            <div class="mb-2"><label class="form-label">‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏õ‡∏•‡∏≤ (‡∏Å‡∏£‡∏±‡∏°)</label><input type="number" step="0.001" class="form-control" id="blue-fish-weight" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1.920" required></div>
                        </div>
                    </div>
                    <hr>
                    <div class="mb-3"><label for="bet-amount" class="form-label">üí∞ ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ö‡∏≤‡∏ó)</label><input type="number" class="form-control" id="bet-amount" required></div>
                    
                    <div class="form-check mb-2">
                      <input class="form-check-input" type="checkbox" id="custom-time-checkbox">
                      <label class="form-check-label" for="custom-time-checkbox">
                        ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡πÄ‡∏≠‡∏á (‡∏Å‡∏£‡∏ì‡∏µ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á)
                      </label>
                    </div>
                    <div id="custom-time-container" class="mb-3">
                        <label for="custom-start-time" class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏±‡∏î</label>
                        <input type="datetime-local" class="form-control" id="custom-start-time">
                    </div>

                    <button type="submit" class="btn btn-primary w-100">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                </form>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header bg-danger text-white">‡∏Ñ‡∏π‡πà‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</div>
            <div class="card-body">
                <div id="ongoing-matches" class="row g-3">
                    <p id="no-ongoing-matches" class="text-center text-muted">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏π‡πà‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</p>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header bg-secondary text-white">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</div>
            <div class="card-body">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>‡∏ù‡πà‡∏≤‡∏¢‡πÅ‡∏î‡∏á</th>
                            <th>‡∏ù‡πà‡∏≤‡∏¢‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô</th>
                            <th>‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô</th>
                            <th>‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</th>
                            <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                        </tr>
                    </thead>
                    <tbody id="history-table"></tbody>
                </table>
                <button id="clear-history" class="btn btn-warning mt-3">‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const DURATION = 3 * 60 * 60 * 1000;
    const matchForm = document.getElementById('match-form');
    const ongoingMatchesContainer = document.getElementById('ongoing-matches');
    const historyTable = document.getElementById('history-table');
    const noOngoingMatchesText = document.getElementById('no-ongoing-matches');
    const notificationSound = document.getElementById('notification-sound');
    const clearHistoryBtn = document.getElementById('clear-history');
    const customTimeCheckbox = document.getElementById('custom-time-checkbox');
    const customTimeContainer = document.getElementById('custom-time-container');

    let matches = JSON.parse(localStorage.getItem('fishMatchesV3')) || [];
    let activeTimers = {};

    customTimeCheckbox.addEventListener('change', function() {
        if (this.checked) {
            customTimeContainer.style.display = 'block';
            // ### ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö input ###
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('custom-start-time').value = now.toISOString().slice(0, 16);
        } else {
            customTimeContainer.style.display = 'none';
        }
    });

    function saveMatches() {
        localStorage.setItem('fishMatchesV3', JSON.stringify(matches));
    }

    function formatDuration(ms) {
        if (ms < 0) ms = 0;
        const totalSeconds = Math.floor(ms / 1000);
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }

    function render() {
        renderOngoingMatches();
        renderHistory();
    }

    function renderOngoingMatches() {
        ongoingMatchesContainer.innerHTML = '';
        const ongoing = matches.filter(m => m.status === 'ongoing');
        noOngoingMatchesText.style.display = ongoing.length === 0 ? 'block' : 'none';
        ongoing.forEach(match => {
            const col = document.createElement('div');
            col.className = 'col-md-6';
            col.innerHTML = `<div class="card text-center"><div class="card-header"><strong><span class="text-danger">${match.redOwnerName}</span> vs <span class="text-primary">${match.blueOwnerName}</span></strong></div><div class="card-body"><p>‡πÄ‡∏î‡∏¥‡∏°‡∏û‡∏±‡∏ô: ${new Intl.NumberFormat().format(match.bet)} (‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥: ${new Intl.NumberFormat().format(match.houseCut)})</p><div id="timer-${match.id}" class="timer"></div><button class="btn btn-sm btn-warning mt-2 end-match-btn" data-id="${match.id}">‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô</button></div></div>`;
            ongoingMatchesContainer.appendChild(col);
            startTimer(match);
        });
    }

    function renderHistory() {
        historyTable.innerHTML = '';
        const sortedMatches = [...matches].sort((a, b) => new Date(b.startTime) - new Date(a.startTime));
        if (sortedMatches.length > 0) {
            sortedMatches.forEach(match => {
                const isFinished = match.status === 'finished';
                const row = document.createElement('tr');
                const redWeightFormatted = parseFloat(match.redWeight).toFixed(3);
                const blueWeightFormatted = parseFloat(match.blueWeight).toFixed(3);
                let durationText = 'N/A';
                if (isFinished) {
                    durationText = match.matchDuration || '03:00:00';
                }
                row.innerHTML = `<td>${match.id}</td><td>${match.redOwnerName} (${redWeightFormatted}‡∏Å.)</td><td>${match.blueOwnerName} (${blueWeightFormatted}‡∏Å.)</td><td>${new Intl.NumberFormat().format(match.bet)}</td><td>${durationText}</td><td><span class="badge ${isFinished ? 'bg-success' : 'bg-danger'}">${isFinished ? '‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô' : '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Ç‡πà‡∏á'}</span></td>`;
                historyTable.appendChild(row);
            });
        }
    }

    function startTimer(match) {
        if (activeTimers[match.id]) clearInterval(activeTimers[match.id]);
        const timerElement = document.getElementById(`timer-${match.id}`);
        if (!timerElement) return;
        const endTime = new Date(match.endTime).getTime();
        activeTimers[match.id] = setInterval(() => {
            const distance = endTime - new Date().getTime();
            if (distance <= 0) {
                clearInterval(activeTimers[match.id]);
                delete activeTimers[match.id];
                const matchIndex = matches.findIndex(m => m.id === match.id);
                if (matchIndex > -1) {
                    matches[matchIndex].status = 'finished';
                    saveMatches();
                    render();
                }
                notificationSound.play();
                return;
            }
            timerElement.textContent = formatDuration(distance);
        }, 1000);
    }

    matchForm.addEventListener('submit', (e) => {
        e.preventDefault();
        let startTime;
        if (customTimeCheckbox.checked) {
            const customStartTimeValue = document.getElementById('custom-start-time').value;
            // ### ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡∏ñ‡∏π‡∏Å‡πÉ‡∏™‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏à‡∏£‡∏¥‡∏á ‡πÜ ###
            if (!customStartTimeValue) {
                alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô');
                return; // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤
            }
            startTime = new Date(customStartTimeValue);
            // ### ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏°‡∏≤‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ###
            if (isNaN(startTime.getTime())) {
                alert('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
                return; // ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ñ‡πâ‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î
            }
        } else {
            startTime = new Date();
        }

        const betAmount = parseFloat(document.getElementById('bet-amount').value);
        const newMatch = {
            id: matches.length > 0 ? Math.max(...matches.map(m => m.id)) + 1 : 1,
            redOwnerName: document.getElementById('red-owner-name').value,
            redWeight: document.getElementById('red-fish-weight').value,
            blueOwnerName: document.getElementById('blue-owner-name').value,
            blueWeight: document.getElementById('blue-fish-weight').value,
            bet: betAmount,
            houseCut: betAmount * 0.10,
            startTime: startTime.toISOString(),
            endTime: new Date(startTime.getTime() + DURATION).toISOString(),
            status: 'ongoing',
            matchDuration: null
        };
        matches.push(newMatch);
        saveMatches();
        render();
        matchForm.reset();
        customTimeCheckbox.checked = false;
        customTimeContainer.style.display = 'none';
    });

    clearHistoryBtn.addEventListener('click', () => {
        if (confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î? (‡∏Ñ‡∏π‡πà‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Ç‡πà‡∏á‡∏à‡∏∞‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏•‡∏ö)')) {
            matches = matches.filter(m => m.status === 'ongoing');
            saveMatches();
            render();
        }
    });

    ongoingMatchesContainer.addEventListener('click', (e) => {
        if (e.target.classList.contains('end-match-btn')) {
            const matchId = parseInt(e.target.dataset.id, 10);
            if (confirm(`‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏π‡πà‡∏ó‡∏µ‡πà ${matchId} ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)) {
                clearInterval(activeTimers[matchId]);
                delete activeTimers[matchId];
                const matchIndex = matches.findIndex(m => m.id === matchId);
                if (matchIndex > -1) {
                    const match = matches[matchIndex];
                    const actualEndTime = new Date();
                    const startTime = new Date(match.startTime);
                    const durationMs = actualEndTime.getTime() - startTime.getTime();
                    match.status = 'finished';
                    match.matchDuration = formatDuration(durationMs);
                    saveMatches();
                    render();
                }
            }
        }
    });
    
    render();
});
</script>
</body>
</html>
